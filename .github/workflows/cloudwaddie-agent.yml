name: CloudWaddie Agent

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Custom prompt"
        required: false
  issue_comment:
    types: [created]
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited]

jobs:
  agent:
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && github.event.comment.user.login != 'cloudwaddie-agent') ||
      github.event_name == 'issues' ||
      github.event_name == 'pull_request'
    env:
      GH_TOKEN: ${{ secrets.GH_PAT }}

    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Check if bot was mentioned and user is contributor
        id: validation
        if: github.event_name == 'issue_comment'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          REPO: ${{ github.repository }}
        run: |
          if [[ ! "$COMMENT_BODY" =~ @cloudwaddie-agent ]]; then
            echo "Bot not mentioned, skipping"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          AUTHOR_ASSOCIATION=$(gh api "repos/$REPO/issues/comments/${{ github.event.comment.id }}" --jq '.author_association')
          
          if [[ "$AUTHOR_ASSOCIATION" == "OWNER" ]] || \
             [[ "$AUTHOR_ASSOCIATION" == "MEMBER" ]] || \
             [[ "$AUTHOR_ASSOCIATION" == "COLLABORATOR" ]] || \
             [[ "$AUTHOR_ASSOCIATION" == "CONTRIBUTOR" ]]; then
            echo "User is a contributor, proceeding"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "User is not a contributor, skipping"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Check user eligibility for issues/PRs
        id: validation_issue_pr
        if: github.event_name == 'issues' || github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
        run: |
          if [[ "$EVENT_NAME" == "issues" ]]; then
            AUTHOR="${{ github.event.issue.user.login }}"
          else
            AUTHOR="${{ github.event.pull_request.user.login }}"
          fi

          AUTHOR_ASSOCIATION=$(gh api "repos/$REPO/issues/${{ github.event.issue.number || github.event.pull_request.number }}" --jq '.author_association')
          
          if [[ "$AUTHOR_ASSOCIATION" != "OWNER" ]] && \
             [[ "$AUTHOR_ASSOCIATION" != "MEMBER" ]] && \
             [[ "$AUTHOR_ASSOCIATION" != "COLLABORATOR" ]] && \
             [[ "$AUTHOR_ASSOCIATION" != "CONTRIBUTOR" ]]; then
            echo "User is not a contributor, skipping"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          USER_DATA=$(gh api "users/$AUTHOR")
          CREATED_AT=$(echo "$USER_DATA" | jq -r '.created_at')
          CREATED_DATE=$(date -d "$CREATED_AT" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$CREATED_AT" +%s 2>/dev/null)
          TODAY=$(date +%s)
          DAYS_OLD=$(( (TODAY - CREATED_DATE) / 86400 ))

          if [[ $DAYS_OLD -lt 30 ]]; then
            echo "User account is only $DAYS_OLD days old (need 30+), skipping"
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "User account is $DAYS_OLD days old, proceeding"
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v5
        if: >-
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'issue_comment' && steps.validation.outputs.should_run == 'true') ||
          (github.event_name == 'issues' && steps.validation_issue_pr.outputs.should_run == 'true') ||
          (github.event_name == 'pull_request' && steps.validation_issue_pr.outputs.should_run == 'true')
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Configure Git as cloudwaddie-agent
        if: >-
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'issue_comment' && steps.validation.outputs.should_run == 'true') ||
          (github.event_name == 'issues' && steps.validation_issue_pr.outputs.should_run == 'true') ||
          (github.event_name == 'pull_request' && steps.validation_issue_pr.outputs.should_run == 'true')
        run: |
          git config user.name "cloudwaddie-agent"
          git config user.email "cloudwaddie-agent@users.noreply.github.com"

      - name: Ensure tmux is available (Linux)
        if: >-
          (github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'issue_comment' && steps.validation.outputs.should_run == 'true') ||
          (github.event_name == 'issues' && steps.validation_issue_pr.outputs.should_run == 'true') ||
          (github.event_name == 'pull_request' && steps.validation_issue_pr.outputs.should_run == 'true'))
          && runner.os == 'Linux'
        run: |
          set -euo pipefail
          if ! command -v tmux >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends tmux
          fi
          tmux -V

      - name: Setup Bun
        if: >-
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'issue_comment' && steps.validation.outputs.should_run == 'true') ||
          (github.event_name == 'issues' && steps.validation_issue_pr.outputs.should_run == 'true') ||
          (github.event_name == 'pull_request' && steps.validation_issue_pr.outputs.should_run == 'true')
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Checkout oh-my-opencode dev branch
        if: >-
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'issue_comment' && steps.validation.outputs.should_run == 'true') ||
          (github.event_name == 'issues' && steps.validation_issue_pr.outputs.should_run == 'true') ||
          (github.event_name == 'pull_request' && steps.validation_issue_pr.outputs.should_run == 'true')
        uses: actions/checkout@v5
        with:
          repository: code-yeongyu/oh-my-opencode
          ref: dev
          path: oh-my-opencode

      - name: Build oh-my-opencode from source
        if: >-
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'issue_comment' && steps.validation.outputs.should_run == 'true') ||
          (github.event_name == 'issues' && steps.validation_issue_pr.outputs.should_run == 'true') ||
          (github.event_name == 'pull_request' && steps.validation_issue_pr.outputs.should_run == 'true')
        working-directory: oh-my-opencode
        run: |
          bun install
          bun run build

      - name: Setup OpenCode with oh-my-opencode
        if: >-
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'issue_comment' && steps.validation.outputs.should_run == 'true') ||
          (github.event_name == 'issues' && steps.validation_issue_pr.outputs.should_run == 'true') ||
          (github.event_name == 'pull_request' && steps.validation_issue_pr.outputs.should_run == 'true')
        env:
          OPENCODE_AUTH_JSON: ${{ secrets.OPENCODE_AUTH_JSON || '' }}
        run: |
          export PATH="$HOME/.opencode/bin:$PATH"

          # Install OpenCode (skip if cached)
          if ! command -v opencode &>/dev/null; then
            echo "Installing OpenCode..."
            curl -fsSL https://opencode.ai/install -o /tmp/opencode-install.sh
            if file /tmp/opencode-install.sh | grep -q "shell script\|text"; then
              if ! bash /tmp/opencode-install.sh 2>&1; then
                echo "Default installer failed, trying direct install..."
                bash <(curl -fsSL https://opencode.ai/install)
              fi
            else
              echo "Download corrupted, trying direct install..."
              bash <(curl -fsSL https://opencode.ai/install)
            fi
          fi
          opencode --version

          # Install oh-my-opencode plugin using locally built version
          bun run oh-my-opencode/dist/cli/index.js install --no-tui --claude=no --openai=no --gemini=no --copilot=no --opencode-zen=no

          # List available free opencode models (for visibility)
          opencode models

          # Override plugin to use local source files (like sisyphus-agent does)
          OPENCODE_JSON=~/.config/opencode/opencode.json
          REPO_PATH=$(pwd)/oh-my-opencode
          jq --arg path "file://$REPO_PATH/src/index.ts" '
            .plugin = [.plugin[] | select(. != "oh-my-opencode")] + [$path]
          ' "$OPENCODE_JSON" > /tmp/oc.json && mv /tmp/oc.json "$OPENCODE_JSON"

          # Configure OpenCode auth (if provided)
          if [[ -n "$OPENCODE_AUTH_JSON" ]]; then
            mkdir -p ~/.local/share/opencode
            echo "$OPENCODE_AUTH_JSON" > ~/.local/share/opencode/auth.json
            chmod 600 ~/.local/share/opencode/auth.json
          else
            echo "No OPENCODE_AUTH_JSON provided - using free models only"
          fi

          # Set default model to opencode/big-pickle
          CONFIG=~/.config/opencode/opencode.json
          if [ -f "$CONFIG" ]; then
            jq '(.model = "opencode/big-pickle")' "$CONFIG" > /tmp/oc.json && mv /tmp/oc.json "$CONFIG"
          else
            mkdir -p ~/.config/opencode
            printf '%s\n' '{' '  "$schema": "https://opencode.ai/config.json",' '  "model": "opencode/big-pickle"' '}' > "$CONFIG"
          fi
          OMO=~/.config/opencode/oh-my-opencode.json
          if [ -f "$OMO" ]; then
            jq '(.model = "opencode/big-pickle")' "$OMO" > /tmp/omo.json && mv /tmp/omo.json "$OMO"
          fi

      - name: Collect Context
        id: context
        if: >-
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'issue_comment' && steps.validation.outputs.should_run == 'true') ||
          (github.event_name == 'issues' && steps.validation_issue_pr.outputs.should_run == 'true') ||
          (github.event_name == 'pull_request' && steps.validation_issue_pr.outputs.should_run == 'true')
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          COMMENT_ID_VAL: ${{ github.event.comment.id }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          REPO: ${{ github.repository }}
        run: |
          if [[ "$EVENT_NAME" == "issue_comment" ]]; then
            ISSUE_NUM="$ISSUE_NUMBER"
            AUTHOR="$COMMENT_AUTHOR"
            COMMENT_ID="$COMMENT_ID_VAL"

            ISSUE_DATA=$(gh api "repos/$REPO/issues/${ISSUE_NUM}")
            TITLE=$(echo "$ISSUE_DATA" | jq -r '.title')
            if echo "$ISSUE_DATA" | jq -e '.pull_request' > /dev/null; then
              echo "type=pr" >> $GITHUB_OUTPUT
              echo "number=${ISSUE_NUM}" >> $GITHUB_OUTPUT
            else
              echo "type=issue" >> $GITHUB_OUTPUT
              echo "number=${ISSUE_NUM}" >> $GITHUB_OUTPUT
            fi
            echo "title=${TITLE}" >> $GITHUB_OUTPUT
            echo "comment=${COMMENT_BODY}" >> $GITHUB_OUTPUT
          elif [[ "$EVENT_NAME" == "issues" ]]; then
            ISSUE_NUM="$ISSUE_NUMBER"
            AUTHOR="${{ github.event.issue.user.login }}"
            echo "type=issue" >> $GITHUB_OUTPUT
            echo "number=${ISSUE_NUM}" >> $GITHUB_OUTPUT
            echo "title=${ISSUE_TITLE}" >> $GITHUB_OUTPUT
            COMMENT_BODY="[Issue opened/edited]: ${ISSUE_TITLE}"
            if [[ -n "$ISSUE_BODY" ]]; then
              COMMENT_BODY="${COMMENT_BODY}\n\n${ISSUE_BODY}"
            fi
            echo "comment=${COMMENT_BODY}" >> $GITHUB_OUTPUT
          elif [[ "$EVENT_NAME" == "pull_request" ]]; then
            PR_NUM="$PR_NUMBER"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            echo "type=pr" >> $GITHUB_OUTPUT
            echo "number=${PR_NUM}" >> $GITHUB_OUTPUT
            echo "title=${PR_TITLE}" >> $GITHUB_OUTPUT
            COMMENT_BODY="[PR opened/edited]: ${PR_TITLE}"
            if [[ -n "$PR_BODY" ]]; then
              COMMENT_BODY="${COMMENT_BODY}\n\n${PR_BODY}"
            fi
            echo "comment=${COMMENT_BODY}" >> $GITHUB_OUTPUT
          fi

          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "comment_id=" >> $GITHUB_OUTPUT

      - name: Add eyes reaction
        if: >-
          (github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'issue_comment' && steps.validation.outputs.should_run == 'true') ||
          (github.event_name == 'issues' && steps.validation_issue_pr.outputs.should_run == 'true') ||
          (github.event_name == 'pull_request' && steps.validation_issue_pr.outputs.should_run == 'true'))
          && steps.context.outputs.comment_id != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
            -X POST -f content="eyes" || true

      - name: Add reaction to issue/PR
        if: >-
          (github.event_name == 'issues' || github.event_name == 'pull_request') &&
          (steps.validation_issue_pr.outputs.should_run == 'true')
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          if [[ "${{ steps.context.outputs.type }}" == "pr" ]]; then
            gh api "/repos/${{ github.repository }}/pulls/${{ steps.context.outputs.number }}/reactions" \
              -X POST -f content="eyes" || true
          else
            gh api "/repos/${{ github.repository }}/issues/${{ steps.context.outputs.number }}/reactions" \
              -X POST -f content="eyes" || true
          fi

      - name: Add working label
        if: >-
          (github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'issue_comment' && steps.validation.outputs.should_run == 'true') ||
          (github.event_name == 'issues' && steps.validation_issue_pr.outputs.should_run == 'true') ||
          (github.event_name == 'pull_request' && steps.validation_issue_pr.outputs.should_run == 'true'))
          && steps.context.outputs.number != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh label create "cloudwaddie-agent: working" \
            --repo "${{ github.repository }}" \
            --color "fcf2e1" \
            --description "CloudWaddie-agent is currently working on this" \
            --force || true

          if [[ "${{ steps.context.outputs.type }}" == "pr" ]]; then
            gh pr edit "${{ steps.context.outputs.number }}" \
              --repo "${{ github.repository }}" \
              --add-label "cloudwaddie-agent: working" || true
          else
            gh issue edit "${{ steps.context.outputs.number }}" \
              --repo "${{ github.repository }}" \
              --add-label "cloudwaddie-agent: working" || true
          fi

      - name: Run cloudwaddie-agent (oh-my-opencode)
        if: >-
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'issue_comment' && steps.validation.outputs.should_run == 'true') ||
          (github.event_name == 'issues' && steps.validation_issue_pr.outputs.should_run == 'true') ||
          (github.event_name == 'pull_request' && steps.validation_issue_pr.outputs.should_run == 'true')
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          USER_COMMENT: ${{ steps.context.outputs.comment }}
          COMMENT_AUTHOR: ${{ steps.context.outputs.author }}
          CONTEXT_TYPE: ${{ steps.context.outputs.type }}
          CONTEXT_NUMBER: ${{ steps.context.outputs.number }}
          CONTEXT_TITLE: ${{ steps.context.outputs.title }}
          REPO_NAME: ${{ github.repository }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          EVENT_NAME: ${{ github.event_name }}
          MANUAL_PROMPT: ${{ github.event.inputs.prompt }}
        run: |
          export PATH="$HOME/.opencode/bin:$PATH"

          # Handle workflow_dispatch (manual testing) differently
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            if [[ -n "$MANUAL_PROMPT" ]]; then
              # User provided a custom prompt
              TEST_PROMPT="You are cloudwaddie-agent, an autonomous bot made by CloudWaddie.

              User's test request: $MANUAL_PROMPT

              Repository: $REPO_NAME

              This is a manual test run. Respond with a simple acknowledgment."
            else
              # Default test prompt
              TEST_PROMPT="You are cloudwaddie-agent, an autonomous bot made by CloudWaddie.

              This is a manual test run of the workflow in repository $REPO_NAME.

              Please respond with: 'CloudWaddie Agent test successful! The workflow is working correctly.'"
            fi
            
            stdbuf -oL -eL bun run oh-my-opencode/dist/cli/index.js run "$TEST_PROMPT"
            exit 0
          fi

          PROMPT=$(cat <<'PROMPT_EOF'
          You are cloudwaddie-agent, an autonomous bot made by CloudWaddie.

          First, read full issue/PR context and comments. Then respond with a helpful comment.
          Avoid making code changes unless explicitly requested.

          Context:
          - Repo: REPO_PLACEHOLDER
          - Type: TYPE_PLACEHOLDER
          - Number: #NUMBER_PLACEHOLDER
          - Title: TITLE_PLACEHOLDER
          - Comment author: AUTHOR_PLACEHOLDER

          User comment:
          COMMENT_PLACEHOLDER

          Always comment back using gh issue comment or gh pr comment. Use heredoc for markdown.
          PROMPT_EOF
          )

          PROMPT="${PROMPT//AUTHOR_PLACEHOLDER/$COMMENT_AUTHOR}"
          PROMPT="${PROMPT//REPO_PLACEHOLDER/$REPO_NAME}"
          PROMPT="${PROMPT//TYPE_PLACEHOLDER/$CONTEXT_TYPE}"
          PROMPT="${PROMPT//NUMBER_PLACEHOLDER/$CONTEXT_NUMBER}"
          PROMPT="${PROMPT//TITLE_PLACEHOLDER/$CONTEXT_TITLE}"
          PROMPT="${PROMPT//COMMENT_PLACEHOLDER/$USER_COMMENT}"

          stdbuf -oL -eL bun run oh-my-opencode/dist/cli/index.js run "$PROMPT"


      - name: Update reaction and remove label
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          if [[ -n "${{ steps.context.outputs.comment_id }}" ]]; then
            REACTION_ID=$(gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
              --jq '.[] | select(.content == "eyes" and .user.login == "cloudwaddie-agent") | .id' | head -1)
            if [[ -n "$REACTION_ID" ]]; then
              gh api -X DELETE "/repos/${{ github.repository }}/reactions/${REACTION_ID}" || true
            fi

            gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
              -X POST -f content="+1" || true
          fi

          if [[ "${{ github.event_name }}" == "issues" ]] || [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ steps.context.outputs.type }}" == "pr" ]]; then
              REACTION_ID=$(gh api "/repos/${{ github.repository }}/pulls/${{ steps.context.outputs.number }}/reactions" \
                --jq '.[] | select(.content == "eyes" and .user.login == "cloudwaddie-agent") | .id' | head -1)
              if [[ -n "$REACTION_ID" ]]; then
                gh api -X DELETE "/repos/${{ github.repository }}/reactions/${REACTION_ID}" || true
              fi
              gh api "/repos/${{ github.repository }}/pulls/${{ steps.context.outputs.number }}/reactions" \
                -X POST -f content="+1" || true
            else
              REACTION_ID=$(gh api "/repos/${{ github.repository }}/issues/${{ steps.context.outputs.number }}/reactions" \
                --jq '.[] | select(.content == "eyes" and .user.login == "cloudwaddie-agent") | .id' | head -1)
              if [[ -n "$REACTION_ID" ]]; then
                gh api -X DELETE "/repos/${{ github.repository }}/reactions/${REACTION_ID}" || true
              fi
              gh api "/repos/${{ github.repository }}/issues/${{ steps.context.outputs.number }}/reactions" \
                -X POST -f content="+1" || true
            fi
          fi

          if [[ -n "${{ steps.context.outputs.number }}" ]]; then
            if [[ "${{ steps.context.outputs.type }}" == "pr" ]]; then
              gh pr edit "${{ steps.context.outputs.number }}" \
                --repo "${{ github.repository }}" \
                --remove-label "cloudwaddie-agent: working" || true
            else
              gh issue edit "${{ steps.context.outputs.number }}" \
                --repo "${{ github.repository }}" \
                --remove-label "cloudwaddie-agent: working" || true
            fi
          fi
